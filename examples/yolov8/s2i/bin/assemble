#!/bin/bash
set -e

usage(){
  "${STI_SCRIPTS_PATH}/usage"
}

debug(){
  echo "
    This process is runing as $(id)
    Path: $(pwd)
  "
  [ -d /tmp/src ] && ls -lRh /tmp/src 
  ls -lRh "${HOME}"
}

restore_artifacts(){
  # restore artifacts from a previous build (if they exist)

  if [ "$(ls /tmp/artifacts/ 2>/dev/null)" ]; then
    echo "---> Restoring build artifacts..."
    mv /tmp/artifacts/* /opt/app-root/include
  fi
}

fix_perms(){
  # set permissions for any installed artifacts
  fix-permissions "${APP_ROOT}" -P
}

build_onnx(){
  MODEL_NAME=${1:-yolo8s.pt}

  echo "MODEL_NAME: ${MODEL_NAME}"

  pip install -U pip
  pip install -r requirements.txt
  yolo export model=yolo8s.pt format=onnx

  # copy model to right location?
}

# usage
# restore_artifacts
build_onnx || debug
fix_perms || debug
